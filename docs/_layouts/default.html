{% assign lang = site.data.translations | find_exp:"item", "item.slug == page.lang" | first %}<html lang="{{ lang.slug }}">
{% assign losses = site.data.data.en-US %}
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0056B9" />

    <title>{{ lang.page-title }}</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <link href="css/site.css" rel="stylesheet">
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg bg-ua-blue sticky-top text-white">
            <div class="container" aria-label="Main navigation">
                <span class="navbar-brand p-0 me-0 me-lg-2 text-white" aria-label="Orc Losses">
                    <iconify-icon icon="game-icons:orc-head" class="fs-3"></iconify-icon>
                </span>

                <button class="navbar-toggler p-2 text-white border-white" type="button" data-bs-toggle="collapse"
                    data-bs-target="#primary-navigation-menu" aria-controls="primary-navigation-menu"
                    aria-label="Toggle docs navigation">
                    <iconify-icon icon="radix-icons:hamburger-menu"></iconify-icon>
                </button>

                <div id="primary-navigation-menu" class="collapse navbar-collapse">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-text d-none d-lg-inline-block">
                            {{ lang.title }}
                        </li>
                    </ul>
                    <ul class="navbar-nav d-flex">
                        <li class="nav-item dropdown">
                            <a id="theme-menu-toggle" class="nav-link dropdown-toggle text-white" href="#" role="button"
                                aria-haspopup="true" aria-controls="theme-menu" aria-label="{{ lang.theme-label }}"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <iconify-icon class="me-1 align-middle"
                                    icon="material-symbols:light-mode"></iconify-icon>
                                {{ lang.theme-label }}
                            </a>
                            <ul id="theme-menu" class="dropdown-menu" role="menu" aria-labelledby="theme-menu-toggle">
                                <li role="menuitem" onclick="togglePageTheme('light')">
                                    <span class="dropdown-item">
                                        <iconify-icon icon="material-symbols:light-mode"
                                            role="presentation"></iconify-icon>
                                        {{ lang.theme-light-label }}
                                    </span>
                                </li>
                                <li role="menuitem" onclick="togglePageTheme('dark')">
                                    <span class="dropdown-item">
                                        <iconify-icon icon="material-symbols:dark-mode"
                                            role="presentation"></iconify-icon>
                                        {{ lang.theme-dark-label }}
                                    </span>
                                </li>
                            </ul>
                        </li>
                        <li class="nav-item col-12 col-lg-auto text-white py-2 py-lg-1">
                            <div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white-50"></div>
                            <hr class="d-lg-none my-2 text-white-50">
                        </li>
                        <li class="nav-item dropdown">
                            <a id="language-menu-toggle" class="nav-link dropdown-toggle text-white" href="#"
                                role="button" aria-haspopup="true" aria-controls="language-menu" aria-label="{{ lang.language-label }}"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <iconify-icon class="me-1 align-middle" icon="circle-flags:us"></iconify-icon>
                                {{ lang.language-label }}
                            </a>
                            <ul id="language-menu" class="dropdown-menu" role="menu"
                                aria-labelledby="language-menu-toggle">
                                <li role="presentation">
                                    <a role="menuitem" href="/us" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:us" role="presentation"></iconify-icon>
                                        English (US)
                                    </a>
                                </li>
                                <!-- <li role="presentation">
                                    <a role="menuitem" href="/uk" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:uk" role="presentation"></iconify-icon>
                                        English (UK)
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a role="menuitem" href="/fr" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:fr" role="presentation"></iconify-icon>
                                        French
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a role="menuitem" href="/de" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:de" role="presentation"></iconify-icon>
                                        German
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a role="menuitem" href="/ua" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:ua" role="presentation"></iconify-icon>
                                        Ukrainian
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a role="menuitem" href="/ru" class="dropdown-item">
                                        <iconify-icon icon="circle-flags:ru" role="presentation"></iconify-icon>
                                        Russian
                                    </a>
                                </li> -->
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container" aria-live="polite">

        <section class="my-3">
           <p>{{ lang.preamble-paragraph }}</p>
           {{ content }}

        </section>
        <section id="losses-container" class="my-3">
            <div class="row">
                <div class="col">
                    Loading...
                </div>
            </div>
        </section>

        <section id="charts-container" class="my-3">
            <div class="chart-container">
                <div id="line-chart" style="width: 100%; height: 100%;">
                </div>
            </div>
        </section>
    </main>

    <footer class="border-top border-1">
        <div class="container d-flex justify-content-between">
            <div>
                <p class="m-0">
                    <iconify-icon icon="mdi:github" class="me-1 align-middle fs-4"></iconify-icon>
                    <span class="d-inline-block pt-1">View on</span>
                    <a class="btn btn-link px-0" href="https://www.github.com/lod-db/orc-losses"
                        title="Orc Losses on GitHub" target="_blank" rel="noopener noreferrer nofollow">GitHub</a>
                </p>
            </div>
            <div>
                <button type="button" class="btn btn-link" data-bs-toggle="modal" data-bs-target="#modal-tos">Terms of
                    Use</button>
                <button type="button" class="btn btn-link" data-bs-toggle="modal"
                    data-bs-target="#modal-attribution">Attribution</button>
            </div>
        </div>
    </footer>

    <div id="modal-tos" class="modal fade" tabindex="-1"
        aria-labelledby="modal-tos-title" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 id="modal-tos-title" class="modal-title fs-5">Terms of Use</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% include tos.html %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Understood</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-attribution" class="modal fade" tabindex="-1"
        aria-labelledby="modal-attribution-title" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 id="modal-attribution-title" class="modal-title fs-5">Attribution</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% include attribution.html %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        let theme = 'light';
        function togglePageTheme(t, save = true) {
            theme = t;
            const htmlEle = document.getElementsByTagName('html')[0];
            const toggleEle = document.getElementById('theme-menu-toggle');
            const iconEle = toggleEle.querySelector('iconify-icon');

            htmlEle.setAttribute('data-bs-theme', theme);
            iconEle.setAttribute('icon', `material-symbols:${theme}-mode`);

            if (save) {
                localStorage.setItem('theme', theme);
            }

            try { initLineChart() } catch (err) { }
        }

        (function () {
            theme = localStorage.getItem('theme');
            const isDarkTheme = theme
                ? theme === 'dark'
                : window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (isDarkTheme) {
                togglePageTheme('dark', false);
            }
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
        integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@2.1.0/dist/iconify-icon.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.5.0/echarts.min.js"
        integrity="sha512-k37wQcV4v2h6jgYf5IUz1MoSKPpDs630XGSmCaCCOXxy2awgAWKHGZWr9nMyGgk3IOxA1NxdkN8r1JHgkUtMoQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // Set Globals
        const locale = '{{ lang.slug }}';
        const charts = {};
        const lossesDict = {};
        const lossesSorted = (function () {
            const json = {{ losses | jsonify }}
            const lossesSorted = json.toSorted((a, b) => a.date.localeCompare(b.date, 'en'));

            for (const loss of lossesSorted) {
                lossesDict[loss.date] = loss;
            }

            return lossesSorted;
        })();
        const dateRange = (function () {
            // Date constructor w/o time sets underlying date in UTC. Adding time keeps it local
            let date = new Date(lossesSorted[0].date + 'T00:00:00');
            const dateToday = new Date(lossesSorted[lossesSorted.length - 1].date + 'T00:00:00');
            const dateRange = [];
            while (date <= dateToday) {
                const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                dateRange.push(dateKey);

                date = new Date(date.getTime() + 86400000);
            };

            return dateRange;
        })();
        const isNull = (val) => typeof val === 'undefined' || val === null;
    </script>
    <script>
        // Create Losses Table
        (function () {
            const current = lossesDict[dateRange[dateRange.length - 1]];
            const previous = lossesDict[dateRange[dateRange.length - 2]];

            const containerEle = document.getElementById('losses-container');
            const rowEle = containerEle.getElementsByClassName('row')[0];
            const lossCategories = [
                { id: 'personnel', key: 'personnel', name: 'Personnel', icon: 'helmet' },
                { id: 'artillery', key: 'artillery', name: 'Artillery', icon: 'artillery' },
                { id: 'jets', key: 'fixedWingAircraft', name: 'Planes', icon: 'jet' },
                { id: 'helicopters', key: 'rotoryWingAircraft', name: 'Helicopters', icon: 'helicopter' },
                { id: 'tanks', key: 'tanks', name: 'Tanks', icon: 'tank' },
                { id: 'afvs', key: 'afvs', name: 'Armored Fighting Vehicles', icon: 'afv' },
                { id: 'mlrs', key: 'rocketSystems', name: 'Rocket Systems', icon: 'mlrs' },
                { id: 'aa', key: 'airDefense', name: 'Anti-Air Systems', icon: 'radar' },
                { id: 'ships', key: 'ships', name: 'Ships', icon: 'ship' },
                { id: 'submarines', key: 'submarines', name: 'Submarines', icon: 'submarine' },
                { id: 'vehicles', key: 'unarmoredVehicles', name: 'Unarmored Vehicles', icon: 'vehicle' },
                { id: 'special', key: 'specialEquipment', name: 'Special Equipment', icon: 'bulldozer' },
                { id: 'uavs', key: 'uavs', name: 'Unmanned Aerial Vehicles', icon: 'uav' },
                { id: 'missiles', key: 'missiles', name: 'Missiles', icon: 'missile' },
            ];
            const colEles = lossCategories.map(c => {
                const currVal = current ? current[c.key] : null;
                const prevVal = previous ? previous[c.key] : null;
                const diffVal = currVal && prevVal ? Math.max(currVal - prevVal, 0) : null;

                const rootEle = document.createElement('div');
                rootEle.className = 'col-12 col-md-6 col-lg-4 col-xxl-3 mb-3';

                const containerEle = document.createElement('div');
                containerEle.className = 'd-flex flex-column justify-content-between p-3 h-100 border border-1';
                rootEle.appendChild(containerEle);

                const headerGroupEle = document.createElement('div');
                headerGroupEle.className = 'd-flex justify-content-between';
                containerEle.appendChild(headerGroupEle);

                const nameEle = document.createElement('h3');
                nameEle.innerText = c.name;
                headerGroupEle.appendChild(nameEle);

                const imgLightEle = document.createElement('img');
                imgLightEle.className = 'icon light mx-1';
                imgLightEle.title = c.name;
                imgLightEle.src = `icon/${c.icon}.png`
                imgLightEle.ariaHidden = true;
                headerGroupEle.appendChild(imgLightEle);

                const imgDarkEle = document.createElement('img');
                imgDarkEle.className = 'icon dark mx-1';
                imgDarkEle.title = c.name;
                imgDarkEle.src = `icon/${c.icon}-white.png`
                imgDarkEle.ariaHidden = true;
                headerGroupEle.appendChild(imgDarkEle);

                const numberEle = document.createElement('p');
                numberEle.className = 'text-center my-0';
                numberEle.setAttribute('aria-describedby', `losses-${c.id}-description`);
                numberEle.innerText = !isNull(currVal)
                    ? `${c.id === 'personnel' ? '~' : ''}${currVal.toLocaleString(locale)}`
                    : '—';
                containerEle.appendChild(numberEle);

                if (diffVal && diffVal > 0) {
                    const diffEle = document.createElement('strong');
                    diffEle.className = 'small';
                    diffEle.innerText = `(+${diffVal.toLocaleString(locale)})`;
                    numberEle.appendChild(document.createTextNode(' '));
                    numberEle.appendChild(diffEle);
                }

                const descriptionEle = document.createElement('p');
                descriptionEle.id = `losses-${c.id}-description`;
                descriptionEle.className = 'visually-hidden';
                descriptionEle.innerText = !isNull(currVal)
                    ? `${c.id === 'personnel' ? '~' : ''}${currVal} ${c.name} lost since 2022.`
                    : 'No data available on this date';
                containerEle.appendChild(descriptionEle);

                return rootEle;
            });

            rowEle.innerHTML = '';
            for (let ele of colEles) {
                rowEle.appendChild(ele);
            }
        })();
    </script>
    <script>
        // Create Line Chart
        function initLineChart() {
            if (charts['line']) {
                charts['line'].dispose();
            }

            const markArea = {
                itemStyle: {
                    color: 'rgba(225, 225, 225, 0.4)'
                },
                data: [],
            };

            function createLineSeries(data) {
                const dataPoints = [
                    {
                        name: 'Personnel',
                        data: data.map(d => d?.personnel),
                    },
                    {
                        name: 'Tanks',
                        data: data.map(d => d?.tanks),
                    },
                    {
                        name: 'Armored Fighting Vehicles',
                        data: data.map(d => d?.afvs),
                    },
                    {
                        name: 'Artillery',
                        data: data.map(d => d?.artillery),
                    },
                    {
                        name: 'Anti Air Systems',
                        data: data.map(d => d?.airDefense),
                    },
                    {
                        name: 'Rocket Systems',
                        data: data.map(d => d?.rocketSystems),
                    },
                    {
                        name: 'Unarmored Vehicles',
                        data: data.map(d => d?.unarmoredVehicles),
                    },
                    {
                        name: 'Planes / Jets',
                        data: data.map(d => d?.fixedWingAircraft),
                    },
                    {
                        name: 'Helicopters',
                        data: data.map(d => d?.rotoryWingAircraft),
                    },
                    {
                        name: 'Unmanned Aerial Vehicles',
                        data: data.map(d => d?.uavs),
                    },
                    {
                        name: 'Ships',
                        data: data.map(d => d?.ships),
                    },
                    {
                        name: 'Submarines',
                        data: data.map(d => d?.submarines),
                    },
                    {
                        name: 'Special Equipment',
                        data: data.map(d => d?.specialEquipment),
                    },
                    {
                        name: 'Missles',
                        data: data.map(d => d?.missiles),
                    },
                ];
                const items = dataPoints.map((d, i) => ({
                    type: 'line',
                    name: d.name,
                    data: d.data,
                    connectNulls: true,
                    markArea: i === 0 ? markArea : {},
                    stack: 'Total',
                    areaStyle: {},
                    emphasis: {
                        focus: 'series',
                    },
                    label: {
                        show: true,
                        position: 'top',
                    },
                }));

                return items;
            }

            const series = createLineSeries(dateRange.map((d) => lossesDict[d]));

            const lineChart = echarts.init(document.getElementById('line-chart'), theme);
            markArea.data = [
                [
                    {
                        name: 'Battle of Kyiv',
                        // This started 2022-02-25 but data starts 2022-02-27
                        xAxis: '2022-02-27',
                    },
                    {
                        xAxis: '2022-04-02',
                    },
                ],
                [
                    {
                        name: 'Battle of Bakhmut',
                        xAxis: '2022-06-03',
                    },
                    {
                        xAxis: '2023-05-20',
                    },
                ],
                [
                    {
                        name: 'Kharkiv Counteroffensive',
                        xAxis: '2022-09-06',
                    },
                    {
                        xAxis: '2022-10-01',
                    },
                ],
                [
                    {
                        name: 'Kharkiv Counteroffensive',
                        xAxis: '2022-09-06',
                    },
                    {
                        xAxis: '2022-10-01',
                    },
                ],
            ];
            const lineChartOptions = {
                title: {
                    //text: 'Russian Losses in Ukraine',
                    subtext: `2022 - ${new Date(lossesSorted[lossesSorted.length - 1].date).getFullYear()}`,
                    left: 'center',
                },
                darkMode: 'auto',
                series,
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross',
                        label: {
                            backgroundColor: '#6a7985',
                        },
                    },
                },
                legend: {
                    type: 'scroll',
                    orient: 'vertical',
                    left: 15,
                    top: 75,
                    bottom: 20,
                    show: false,
                },
                toolbox: {
                    show: true,
                    feature: {
                        dataZoom: {
                            yAxisIndex: 'none',
                        },
                        dataView: {
                            readOnly: true,
                        },
                        restore: {},
                        saveAsImage: {},
                    },
                },
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0],
                        start: 0,
                        end: 100,
                    },
                    {
                        type: 'slider',
                        yAxisIndex: [0],
                        start: 0,
                        end: 100,
                    },
                ],
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    containLabel: true,
                },
                xAxis: [
                    {
                        type: 'category',
                        boundaryGap: false,
                        data: dateRange,
                    },
                ],
                yAxis: [
                    {
                        type: 'value',
                    },
                ],
            };

            lineChartOptions && lineChart.setOption(lineChartOptions);

            charts['line'] = lineChart;
        };
        initLineChart();
    </script>
</body>

</html>
